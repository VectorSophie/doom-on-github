<!DOCTYPE html>
<html>
<head>
    <title>Doom Engine Test</title>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: monospace; display: flex; flex-direction: column; align-items: center; }
        canvas { 
            image-rendering: pixelated; 
            width: 530px; 
            height: 390px; 
            border: 1px solid #30363d; 
            background: #000;
        }
        #controls { margin-top: 20px; text-align: center; }
        .key { display: inline-block; padding: 5px 10px; border: 1px solid #30363d; margin: 2px; border-radius: 4px; }
        .active { background: #238636; color: white; }
    </style>
</head>
<body>
    <h1>Doom Engine Test (53x39)</h1>
    <canvas id="screen" width="53" height="39"></canvas>
    <div id="status">Loading...</div>
    <div id="controls">
        Controls: Arrows (Move), Ctrl (Fire), Space (Open), Esc (Menu)
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');

        // Color palette (Github Contribution Graph colors)
        // Level 0-4
        const COLORS = [
            '#161b22', // 0: Empty
            '#0e4429', // 1: Low
            '#006d32', // 2: Medium
            '#26a641', // 3: High
            '#39d353'  // 4: Highest
        ];

        // Worker Setup
        const worker = new Worker('worker.js');

        worker.onmessage = (e) => {
            const { type, payload } = e.data;

            if (type === 'FRAME') {
                renderFrame(payload);
                status.textContent = 'Running';
                // Debug log first few frames
                if (window.frameDebugCount === undefined) window.frameDebugCount = 0;
                if (window.frameDebugCount < 10) {
                    console.log('Received Frame. First 10 bytes:', payload.slice(0, 10));
                    window.frameDebugCount++;
                }
            } else {
                console.log('Main:', e.data);
            }
        };

        // Render 53x39 buffer
        function renderFrame(buffer) {
            // Debug check for non-zero data
            let hasContent = false;
            for(let i=0; i<buffer.length; i++) {
                if(buffer[i] !== 0) { hasContent = true; break; }
            }
            if(!hasContent && window.frameDebugCount < 20) console.log("Frame is all zeros!");

            const imgData = ctx.createImageData(53, 39);
            const data = imgData.data;
            
            for (let i = 0; i < 53 * 39; i++) {
                const val = buffer[i];
                // Color level 0-4?
                // Check if values are actually 0-255 or 0-4
                // Current C code outputs 0-4 (GH_COLOR_LEVELS)
                
                const colorHex = COLORS[val] || COLORS[0];
                
                // Parse Hex
                const r = parseInt(colorHex.slice(1, 3), 16);
                const g = parseInt(colorHex.slice(3, 5), 16);
                const b = parseInt(colorHex.slice(5, 7), 16);

                data[i * 4] = r;
                data[i * 4 + 1] = g;
                data[i * 4 + 2] = b;
                data[i * 4 + 3] = 255; // Alpha
            }
            
            ctx.putImageData(imgData, 0, 0);
        }

        // Input Handling
        const DOOM_KEYS = {
            'ArrowRight': 0xae,
            'ArrowLeft': 0xac,
            'ArrowUp': 0xad,
            'ArrowDown': 0xaf,
            'ControlLeft': 0x80 | 0x1d, // Ctrl (Fire) - generic mapping check
            'ControlRight': 0x80 | 0x1d,
            'Space': 32,
            'Escape': 27,
            'Enter': 13
        };

        // Map Control to Fire (Doom uses Right Ctrl usually, but we map both)
        // Doom generic might map them differently.
        // Let's use simple ASCII for standard keys.

        function sendKey(code, pressed) {
            let key = DOOM_KEYS[code];
            if (!key) {
                // Try ASCII
                if (code.startsWith('Key')) {
                    key = code.charCodeAt(3) + 32; // Lowercase
                }
            }
            
            // Special case for Ctrl = Fire in Doom
            if (code === 'ControlLeft' || code === 'ControlRight') key = 0x9d; // PC Key_Rctrl

            if (key) {
                worker.postMessage({
                    type: 'INPUT',
                    payload: { key, pressed: pressed ? 1 : 0 }
                });
            }
        }

        window.addEventListener('keydown', (e) => {
            sendKey(e.code, true);
        });

        window.addEventListener('keyup', (e) => {
            sendKey(e.code, false);
        });

        // Start
        worker.postMessage({
            type: 'INIT',
            payload: { wasmUrl: '../engine.wasm' }
        });
    </script>
</body>
</html>
